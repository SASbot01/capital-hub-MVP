// frontend/src/pages/company/CompanySettingsPage.tsx
import { useState, useEffect } from "react";
import Topbar from "../../layouts/Topbar";
import { useFetch } from "../../hooks/useFetch";
import { apiClient } from "../../api/client";

interface CompanyProfile {
  id: number;
  userId: number;
  name: string;
  email: string;
  industry: string;
  website: string;
  description: string;
  logoUrl: string;
  size: string;
  location: string;
  foundedYear: number;
  createdAt: string;
}

export default function CompanySettingsPage() {
  const { data: profile, isLoading, error, refetch } = useFetch<CompanyProfile>("/company/me", true);
  
  // Estados del formulario
  const [name, setName] = useState("");
  const [industry, setIndustry] = useState("");
  const [website, setWebsite] = useState("");
  const [description, setDescription] = useState("");
  const [size, setSize] = useState("");
  const [location, setLocation] = useState("");
  
  // Estados de UI
  const [saving, setSaving] = useState(false);
  const [saveMessage, setSaveMessage] = useState<{ type: "success" | "error"; text: string } | null>(null);

  // Cargar datos cuando llega el perfil
  useEffect(() => {
    if (profile) {
      setName(profile.name || "");
      setIndustry(profile.industry || "");
      setWebsite(profile.website || "");
      setDescription(profile.description || "");
      setSize(profile.size || "");
      setLocation(profile.location || "");
    }
  }, [profile]);

  const handleSaveProfile = async () => {
    setSaving(true);
    setSaveMessage(null);
    
    try {
      await apiClient.put("/company/me", {
        name,
        industry,
        website,
        description,
        size,
        location,
      }, true);
      
      setSaveMessage({ type: "success", text: "✅ Cambios guardados correctamente" });
      refetch();
    } catch (err: any) {
      setSaveMessage({ type: "error", text: err?.message || "Error al guardar los cambios" });
    } finally {
      setSaving(false);
    }
  };

  if (isLoading) {
    return (
      <div className="space-y-6 mb-10">
        <Topbar title="Configuración" subtitle="Cargando..." />
        <div className="flex items-center justify-center min-h-[300px]">
          <div className="w-8 h-8 border-4 border-neutral-200 border-t-neutral-800 rounded-full animate-spin"></div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="space-y-6 mb-10">
        <Topbar title="Configuración" subtitle="Error" />
        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-2xl text-sm">
          Error al cargar la configuración.
          <button onClick={refetch} className="underline ml-2">Reintentar</button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6 mb-10">
      <Topbar
        title="Configuración"
        subtitle="Gestiona el perfil de tu empresa"
      />

      {/* Mensaje de estado */}
      {saveMessage && (
        <div className={`px-4 py-3 rounded-2xl text-sm ${
          saveMessage.type === "success" 
            ? "bg-emerald-50 border border-emerald-200 text-emerald-700"
            : "bg-red-50 border border-red-200 text-red-700"
        }`}>
          {saveMessage.text}
        </div>
      )}

      <section className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* INFORMACIÓN DE LA EMPRESA */}
        <div className="bg-white rounded-3xl shadow-sm border border-neutral-200 px-6 py-6">
          <h2 className="text-sm font-semibold mb-4 text-neutral-900">
            Información de la empresa
          </h2>

          <div className="space-y-3">
            <div>
              <label className="block text-[11px] text-neutral-500 mb-1">Nombre de la empresa</label>
              <input
                className="w-full rounded-2xl border border-neutral-200 px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-neutral-900 focus:border-neutral-900 bg-neutral-50"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Nombre de tu empresa"
              />
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label className="block text-[11px] text-neutral-500 mb-1">Industria</label>
                <select 
                  className="w-full rounded-2xl border border-neutral-200 px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-neutral-900 focus:border-neutral-900 bg-neutral-50"
                  value={industry}
                  onChange={(e) => setIndustry(e.target.value)}
                >
                  <option value="">Selecciona una industria</option>
                  <option value="Technology">Tecnología</option>
                  <option value="SaaS">SaaS</option>
                  <option value="E-commerce">E-commerce</option>
                  <option value="Marketing">Marketing</option>
                  <option value="Finance">Finanzas</option>
                  <option value="Education">Educación</option>
                  <option value="Health">Salud</option>
                  <option value="Real Estate">Inmobiliaria</option>
                  <option value="Other">Otra</option>
                </select>
              </div>
              <div>
                <label className="block text-[11px] text-neutral-500 mb-1">Tamaño</label>
                <select 
                  className="w-full rounded-2xl border border-neutral-200 px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-neutral-900 focus:border-neutral-900 bg-neutral-50"
                  value={size}
                  onChange={(e) => setSize(e.target.value)}
                >
                  <option value="">Selecciona el tamaño</option>
                  <option value="1-10">1-10 empleados</option>
                  <option value="11-50">11-50 empleados</option>
                  <option value="51-200">51-200 empleados</option>
                  <option value="201-500">201-500 empleados</option>
                  <option value="500+">500+ empleados</option>
                </select>
              </div>
            </div>

            <div>
              <label className="block text-[11px] text-neutral-500 mb-1">Sitio web</label>
              <input
                type="url"
                className="w-full rounded-2xl border border-neutral-200 px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-neutral-900 focus:border-neutral-900 bg-neutral-50"
                value={website}
                onChange={(e) => setWebsite(e.target.value)}
                placeholder="https://tuempresa.com"
              />
            </div>

            <div>
              <label className="block text-[11px] text-neutral-500 mb-1">Ubicación</label>
              <input
                className="w-full rounded-2xl border border-neutral-200 px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-neutral-900 focus:border-neutral-900 bg-neutral-50"
                value={location}
                onChange={(e) => setLocation(e.target.value)}
                placeholder="Ciudad, País"
              />
            </div>

            <div>
              <label className="block text-[11px] text-neutral-500 mb-1">Descripción</label>
              <textarea
                className="w-full rounded-2xl border border-neutral-200 px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-neutral-900 focus:border-neutral-900 bg-neutral-50 resize-none"
                rows={4}
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="Cuéntanos sobre tu empresa, productos, cultura..."
              />
            </div>
          </div>

          <button 
            onClick={handleSaveProfile}
            disabled={saving}
            className="mt-4 px-4 py-2 text-xs rounded-full bg-black text-white hover:bg-neutral-900 transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {saving ? "Guardando..." : "Guardar cambios"}
          </button>
        </div>

        {/* PANEL LATERAL */}
        <div className="space-y-6">
          {/* LOGO */}
          <div className="bg-white rounded-3xl shadow-sm border border-neutral-200 px-6 py-6">
            <h2 className="text-sm font-semibold mb-3 text-neutral-900">Logo de la empresa</h2>
            <p className="text-xs text-neutral-500 mb-4">
              Tu logo aparecerá en las ofertas de trabajo y en tu perfil público.
            </p>
            
            <div className="flex items-center gap-4">
              {profile?.logoUrl ? (
                <img 
                  src={profile.logoUrl} 
                  alt={name}
                  className="w-16 h-16 rounded-2xl object-cover border border-neutral-200"
                />
              ) : (
                <div className="w-16 h-16 rounded-2xl bg-neutral-100 flex items-center justify-center text-neutral-400">
                  <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
              )}
              <div>
                <button className="px-3 py-1.5 text-xs rounded-full border border-neutral-200 text-neutral-700 hover:bg-neutral-50 transition">
                  Subir logo
                </button>
                <p className="text-[10px] text-neutral-400 mt-1">PNG, JPG. Máx 2MB</p>
              </div>
            </div>
          </div>

          {/* INFORMACIÓN DE CONTACTO */}
          <div className="bg-white rounded-3xl shadow-sm border border-neutral-200 px-6 py-6">
            <h2 className="text-sm font-semibold mb-3 text-neutral-900">Información de contacto</h2>
            <p className="text-xs text-neutral-500 mb-4">
              Esta información se usa para comunicarnos contigo.
            </p>
            
            <div className="space-y-2">
              <div className="flex items-center gap-2 text-xs text-neutral-600">
                <span>✉️</span>
                <span>{profile?.email || "Sin email"}</span>
              </div>
              <p className="text-[10px] text-neutral-400">
                Para cambiar el email de contacto, contacta con soporte.
              </p>
            </div>
          </div>

          {/* ZONA PELIGROSA */}
          <div className="bg-white rounded-3xl shadow-sm border border-neutral-200 px-6 py-6">
            <h2 className="text-sm font-semibold mb-2 text-neutral-900">Zona de peligro</h2>
            <p className="text-xs text-neutral-500 mb-3">
              Acciones irreversibles sobre tu cuenta de empresa.
            </p>
            <button className="px-4 py-2 text-xs rounded-full border border-red-200 text-red-600 hover:bg-red-50 transition">
              Eliminar cuenta de empresa
            </button>
          </div>
        </div>
      </section>
    </div>
  );
}
